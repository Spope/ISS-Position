function initScene(){Detector.webgl||Detector.addGetWebGLMessage({parent:document.getElementById("canvas")}),scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(70,(window.innerWidth-15)/(.8*window.innerHeight),.1,1e6),camera.position.set(0,0,300),renderer=new THREE.WebGLRenderer({alpha:!0}),renderer.setSize(window.innerWidth-15,.8*window.innerHeight),renderer.setClearColorHex(0,1),document.getElementById("canvas").appendChild(renderer.domElement),sun=new THREE.DirectionalLight(16777215,3),sun.position.set(0,0,6e4),scene.add(sun),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.minDistance=180,controls.maxDistance=2e4,controls.noPan=!0,window.addEventListener("resize",onWindowResize),createSatellite(),createEarth(),createMoon(),createLensFlare(),createUniverse(),updateEarthAngle(),updateSatPosition(),updateMoonPosition(),render()}function onWindowResize(){var a=window.innerWidth-15,b=.8*window.innerHeight;renderer.setSize(a,b),camera.aspect=a/b,camera.updateProjectionMatrix()}function createEarth(){var a=100,b={Kr:.0025,Km:.001,ESun:20,g:-.95,innerRadius:a,cloudRadius:1.003*a,outerRadius:1.025*a,wavelength:[.65,.57,.475],scaleDepth:.25,mieScaleDepth:.1},c=THREE.ImageUtils.loadTexture("img/earth/EarthMapAtmos_2500x1250.jpg"),d=THREE.ImageUtils.loadTexture("img/earth/earthNight.jpg"),e=THREE.ImageUtils.loadTexture("img/earth/EarthMask_2500x1250.jpg"),f=THREE.ImageUtils.loadTexture("img/earth/cloudAlpha.png"),g=renderer.getMaxAnisotropy();c.anisotropy=g,d.anisotropy=g,e.anisotropy=g,f.anisotropy=g,uniforms={v3LightPosition:{type:"v3",value:new THREE.Vector3(1e8,0,0).normalize()},v3InvWavelength:{type:"v3",value:new THREE.Vector3(1/Math.pow(b.wavelength[0],4),1/Math.pow(b.wavelength[1],4),1/Math.pow(b.wavelength[2],4))},fCameraHeight:{type:"f",value:0},fCameraHeight2:{type:"f",value:0},fInnerRadius:{type:"f",value:b.innerRadius},fInnerRadius2:{type:"f",value:b.innerRadius*b.innerRadius},fCloudRadius:{type:"f",value:b.cloudRadius},fCloudRadius2:{type:"f",value:b.cloudRadius*b.cloudRadius},fOuterRadius:{type:"f",value:b.outerRadius},fOuterRadius2:{type:"f",value:b.outerRadius*b.outerRadius},fKrESun:{type:"f",value:b.Kr*b.ESun},fKmESun:{type:"f",value:b.Km*b.ESun},fKr4PI:{type:"f",value:4*b.Kr*Math.PI},fKm4PI:{type:"f",value:4*b.Km*Math.PI},fScale:{type:"f",value:1/(b.outerRadius-b.innerRadius)},fScaleDepth:{type:"f",value:b.scaleDepth},fScaleOverScaleDepth:{type:"f",value:1/(b.outerRadius-b.innerRadius)/b.scaleDepth},g:{type:"f",value:b.g},g2:{type:"f",value:b.g*b.g},nSamples:{type:"i",value:3},fSamples:{type:"f",value:3},tDiffuse:{type:"t",value:c},tDiffuseCloud:{type:"t",value:f},tDiffuseNight:{type:"t",value:d},tDisplacement:{type:"t",value:0},tSkyboxDiffuse:{type:"t",value:0},fNightScale:{type:"f",value:1},tSpecular:{type:"t",value:e}},ground={geometry:new THREE.SphereGeometry(b.innerRadius,50,50),material:new THREE.ShaderMaterial({uniforms:uniforms,vertexShader:vertexGround,fragmentShader:fragmentGround})},ground.mesh=new THREE.Mesh(ground.geometry,ground.material),ground.mesh.castShadow=!0,ground.mesh.receiveShadow=!0,scene.add(ground.mesh);var h=100;sky={geometry:new THREE.SphereGeometry(b.outerRadius,h,h),material:new THREE.ShaderMaterial({uniforms:uniforms,vertexShader:vertexSky,fragmentShader:fragmentSky})},sky.mesh=new THREE.Mesh(sky.geometry,sky.material),ground.mesh.castShadow=!0,ground.mesh.receiveShadow=!0,sky.material.side=THREE.BackSide,sky.material.transparent=!0,scene.add(sky.mesh),cloud={geometry:new THREE.SphereGeometry(b.cloudRadius,50,50),material:new THREE.ShaderMaterial({uniforms:uniforms,vertexShader:vertexCloud,fragmentShader:fragmentCloud})},cloud.mesh=new THREE.Mesh(cloud.geometry,cloud.material),cloud.material.transparent=!0,cloud.material.blending=THREE.AdditiveBlending,scene.add(cloud.mesh)}function createMoon(){moon={geometry:new THREE.SphereGeometry(27.2,32,32),material:new THREE.MeshLambertMaterial},moon.material.map=THREE.ImageUtils.loadTexture("img/moonmap.jpg"),moon.mesh=new THREE.Mesh(moon.geometry,moon.material),scene.add(moon.mesh),moon.mesh.position.set(0,0,0)}function createSatellite(){sat={geometry:new THREE.SphereGeometry(1,10,10),material:new THREE.MeshBasicMaterial({color:65280})},sat.mesh=new THREE.Mesh(sat.geometry,sat.material),scene.add(sat.mesh)}function createUniverse(){var a=THREE.ImageUtils.loadTexture("img/galaxy_starfield.png"),b={geometry:new THREE.SphereGeometry(1e6,32,32),material:new THREE.MeshBasicMaterial};b.material.map=a,b.material.side=THREE.BackSide,b.mesh=new THREE.Mesh(b.geometry,b.material),scene.add(b.mesh)}function createLensFlare(){var a=THREE.ImageUtils.loadTexture("img/lensflare/lensflare0.png"),b=THREE.ImageUtils.loadTexture("img/lensflare/lensflare2.png"),c=THREE.ImageUtils.loadTexture("img/lensflare/lensflare3.png"),d=new THREE.Color(16777215);d.setHSL(.55,.9,1),lensFlare=new THREE.LensFlare(a,700,0,THREE.AdditiveBlending,d),lensFlare.add(b,512,0,THREE.AdditiveBlending),lensFlare.add(b,512,0,THREE.AdditiveBlending),lensFlare.add(b,512,0,THREE.AdditiveBlending),lensFlare.add(c,60,.6,THREE.AdditiveBlending),lensFlare.add(c,70,.7,THREE.AdditiveBlending),lensFlare.add(c,120,.9,THREE.AdditiveBlending),lensFlare.add(c,70,1,THREE.AdditiveBlending),lensFlare.position.set(0,0,500),scene.add(lensFlare)}function setXYZ(){var a=new THREE.LineBasicMaterial({color:11862037}),b=new THREE.Geometry;b.vertices.push(new THREE.Vector3(0,0,0)),b.vertices.push(new THREE.Vector3(150,0,0));var c=new THREE.Line(b,a);scene.add(c);var d=new THREE.LineBasicMaterial({color:817664}),e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(0,0,0)),e.vertices.push(new THREE.Vector3(0,150,0));var f=new THREE.Line(e,d);scene.add(f);var g=new THREE.LineBasicMaterial({color:327836}),h=new THREE.Geometry;h.vertices.push(new THREE.Vector3(0,0,0)),h.vertices.push(new THREE.Vector3(0,0,150));var i=new THREE.Line(h,g);scene.add(i)}function updateEarthAngle(){var a=Math.PI/12,b=a/60/60,c=new Date,d=new Date(c.valueOf()+6e4*c.getTimezoneOffset()),e=d.getMinutes(),f=d.getHours(),g=d.getSeconds(),h=g+60*e+60*f*60,i=Math.PI-b*h;eurlerLight=new THREE.Euler(0,i,0);var j=i+Math.PI/2,k=5e5*Math.sin(j),l=5e5*Math.cos(j);lensFlare.position.set(k,0,l),sun.position.set(k,0,l),setTimeout(updateEarthAngle,3e3)}function render(){var a,b,c,d;return requestAnimationFrame(render),controls.update(),d=new THREE.Vector3(1,0,0),c=(new THREE.Matrix4).makeRotationFromEuler(eurlerLight),b=d.applyProjection(c),a=camera.position.length(),sky.material.uniforms.v3LightPosition.value=b,sky.material.uniforms.fCameraHeight.value=a,sky.material.uniforms.fCameraHeight2.value=a*a,ground.material.uniforms.v3LightPosition.value=b,ground.material.uniforms.fCameraHeight.value=a,ground.material.uniforms.fCameraHeight2.value=a*a,cloud.material.uniforms.v3LightPosition.value=b,cloud.material.uniforms.fCameraHeight.value=a,cloud.material.uniforms.fCameraHeight2.value=a*a,renderer.render(scene,camera)}function drawOrbit(a){var b=new THREE.LineBasicMaterial({color:11862037}),c=new THREE.Geometry;for(var d in a)c.vertices.push(new THREE.Vector3(a[d].x,a[d].y,a[d].z));var e=new THREE.Line(c,b);scene.add(e)}function updateSatPosition(){if(earthPositionData){var a=interpolatePosition(earthPositionData,earthReceivedDate);sat.mesh.position.set(a.x,a.y,a.z)}setTimeout(updateSatPosition,100)}function satPosition(a){earthPositionData=a,earthReceivedDate=new Date,sat.mesh.position.set(a[0].x,a[0].y,a[0].z),drawOrbit(a)}function moonPosition(a){moonPositionData=a,moonReceivedDate=new Date,moon.mesh.position.set(a[0].x,a[0].y,a[0].z)}function updateMoonPosition(){if(moonPositionData){var a=interpolatePosition(moonPositionData,moonReceivedDate);moon.mesh.position.set(a.x,a.y,a.z)}setTimeout(updateMoonPosition,200)}function interpolatePosition(a,b){var c=(new Date(a[0].time),new Date),d=c.getSeconds(),e=c.getMilliseconds(),f=c.getMinutes()-b.getMinutes(),g=60*(c.getHours()-b.getHours());f+=g;var h=a[f],i=a[f+1];h||(console.error("No data for current"),console.log(f),console.log(h)),i||(console.error("No data for next"),console.log(f+1),console.log(i));var j=(i.x-h.x)/60,k=(i.y-h.y)/60,l=(i.z-h.z)/60,m=j/1e3,n=k/1e3,o=l/1e3,p={};return p.x=h.x+j*d+m*e,p.y=h.y+k*d+n*e,p.z=h.z+l*d+o*e,p}function scrollTo(a,b,c){var d=a.scrollTop,e=b-d,f=0,g=20,h=function(){f+=g;var b=Math.easeInOutQuad(f,d,e,c);a.scrollTop=b,c>f&&setTimeout(h,g)};h()}var nasaRequest=function(a){var b="Geo",c=start.toISOString(),d=end.toISOString(),e='<?xml version="1.0" encoding="UTF-8" standalone="yes"?><DataRequest xmlns="http://sscweb.gsfc.nasa.gov/schema">',f='<BFieldModel><InternalBFieldModel>IGRF-10</InternalBFieldModel><ExternalBFieldModel xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="Tsyganenko89cBFieldModel"><KeyParameterValues>KP3_3_3</KeyParameterValues></ExternalBFieldModel><TraceStopAltitude>100</TraceStopAltitude></BFieldModel>',g="<OutputOptions><AllLocationFilters>true</AllLocationFilters><CoordinateOptions><CoordinateSystem>"+b+"</CoordinateSystem><Component>X</Component></CoordinateOptions><CoordinateOptions><CoordinateSystem>"+b+"</CoordinateSystem><Component>Y</Component></CoordinateOptions><CoordinateOptions><CoordinateSystem>"+b+"</CoordinateSystem><Component>Z</Component></CoordinateOptions><MinMaxPoints>2</MinMaxPoints></OutputOptions></DataRequest>",h="<TimeInterval><Start>"+c+"</Start><End>"+d+"</End></TimeInterval>",i="<Satellites><Id>"+a+"</Id><ResolutionFactor>1</ResolutionFactor></Satellites>";return e+h+f+i+g},GetPosition=function(a,b,c,d){this.satId=a,this.earthRadiusKm=63.78,this.sscUrl="moon.xml",this.callback=d};GetPosition.prototype.request=function(){var a=nasaRequest(this.satId,this.start,this.end);$.ajax({type:"POST",url:this.sscUrl+"",data:a,dataType:"xml",contentType:"application/xml",processData:!1,success:this.displayData.bind(this),error:this.dataError})},GetPosition.prototype.displayData=function(a){var b=$(a).find("StatusCode").text();return"Success"!=b?void alert("Request for information from SSC failed."):(a=$.xml2json(a),void this.displaySatelliteTrajectory(a))},GetPosition.prototype.displaySatelliteTrajectory=function(a){var b={},c=a.Result.Data.Time,d=a.Result.Data.Coordinates.X,e=a.Result.Data.Coordinates.Y,f=a.Result.Data.Coordinates.Z;for(var g in c)b[g]={time:c[g],x:d[g]/this.earthRadiusKm,y:f[g]/this.earthRadiusKm,z:-(e[g]/this.earthRadiusKm)};this.callback(b)},GetPosition.prototype.dataError=function(a,b,c){var d=$.parseXML(a.responseText),e=$(d).find(".ErrorMessage").text(),f=$(d).find(".ErrorDescription").text();alert("Server request error:\n  HTTP error: "+c+"\n  "+e+"\n  "+f)};var start=new Date,end=new Date;end=new Date(end.getTime()+1104e4),$(function(){new GetPosition("iss",start,end,satPosition),new GetPosition("moon",start,end,moonPosition)});var camera,render,renderer,scene,uniforms,controls,earthPositionData,earthReceivedDate,moon,moonPositionData,moonReceivedDate,lensFlare,eurlerLight,ground,sky,cloud,sat,sun,vertexSky=document.getElementById("vertexSky").textContent,fragmentSky=document.getElementById("fragmentSky").textContent,vertexGround=document.getElementById("vertexGround").textContent,fragmentGround=document.getElementById("fragmentGround").textContent,vertexCloud=document.getElementById("vertexCloud").textContent,fragmentCloud=document.getElementById("fragmentCloud").textContent;initScene();var body=document.body,html=document.documentElement,height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);document.getElementById("btn-bottom").onclick=function(){scrollTo(document.body,height,500)},Math.easeInOutQuad=function(a,b,c,d){return a/=d/2,1>a?c/2*a*a+b:(a--,-c/2*(a*(a-2)-1)+b)};